# Deploying SpringBoot to AWS Beanstalk

---

The whole process is actually rather easy. I used to deploy on self configured EC2 instances 
and must say Beanstalk really makes our job easier to the point where we don't have 
to worry about deployments and can focus on coding.

## Agenda:
- Create SpringBoot application and package it into jar
- Upload jar to Beanstalk

Optional additional steps:
- Purchase and set up personal domain
- Issue and set up SSL certificate in AWS Certificate Manager
- Make necessary redirects in Route53

## Creating and packaging your app

You can of course use your own app or if you just want to follow along, you can download 
mine [here](https://github.com/asgarov1/myApp) (a single page chuck norris generating joke app). Once you have downloaded it 
just run mvn package to create a jar in your target folder.

## Upload jar to Beanstalk
1. Login to AWS Management Console and go to Elastic Beanstalk. There press create new.
<img src="assets/images/beanstalk_post/beanstalk_1.png">
2. Choose web server environment and press next
<img src="assets/images/beanstalk_post/beanstalk_2.png">
3. Choose Managed Platform, pick Java, upload the jar you have created and press create environment
<img src="assets/images/beanstalk_post/beanstalk_3.png">

You will have to wait for your environment to be created. This can take some time and while it is starting you will be seeing the black screen:
<img src="assets/images/beanstalk_post/beanstalk_4.png">

Once it is done you should be seeing this kind of screen and on top left you will find your public url:
<img src="assets/images/beanstalk_post/beanstalk_5.png">

Following that url will give you 502 Bad Gateway response which is expected. By default Beanstalk is looking for application at port 5000 whereas SpringBoot default publishes to 8080.

So go to environment configuration
<img src="assets/images/beanstalk_post/beanstalk_6.png">

Press edit at software section
<img src="assets/images/beanstalk_post/beanstalk_7.png">

And now just add another environment variable SERVER_PORT with value of 5000, following which press apply.
<img src="assets/images/beanstalk_post/beanstalk_8.png">

Once the environment update is done, the application will be available at the public url from before.
<img src="assets/images/beanstalk_post/beanstalk_9.png">


## Registering your own domain
If you are like me, then the autogenerated complicated url from before doesn't fill you with joy, 
and you prefer paying 12 USD for personal domain, especially since you can deploy many apps to subdomains 
of your one purchased domain (that is literally how beanstalk does it:)

Navigate to Route53 in the console and press register domain (don't go into creating host-zones - that will be 
created automatically when your purchase goes through).
<img src="assets/images/beanstalk_post/beanstalk_10.png">

I don't think I need to walk you through this, just pick an available domain that you like and press next couple of times till your bank account is 12 USD lighter

## Issuing SSL to your domain
Now that you are a proud owner of enter-your-awesome-url-here.com you will want to get SSL for it mainly 
because it is easy, free and browsers actively try to prevent you from visiting non-secure pages.
1. Navigate to Certificate Manager and press Request Certificate
   <img src="assets/images/beanstalk_post/beanstalk_11.png">
2. Continue with requesting a public certificate To cover all the possible subdomains I find it easiest to use 
a wildcard:
   <img src="assets/images/beanstalk_post/beanstalk_12.png">
3. Pick DNS validation since it is easiest
   <img src="assets/images/beanstalk_post/beanstalk_13.png">
4. We don't need tags, just press next, review and confirm
5. In the validation step, in domain section you can find a button Create record in Route 53. 
Just select that and AWS will do the DNS configuration for you.
   <img src="assets/images/beanstalk_post/beanstalk_14.png">

Now just sit back and wait till the SSL goes through - can take up to 30 mins.
<img src="assets/images/beanstalk_post/beanstalk_15.png">

## Make necessary redirects in Route53

Now you have the domain with SSL, but you still need to connect it to your Beanstalk App. 
Nothing could be easier:

1. Go to Route 53
2. Navigate to Hosted Zones pick the one that was created for your registered domain (it will have the same name). 
3. Then press on your domain name to go to its records
   <img src="assets/images/beanstalk_post/beanstalk_16.png">
4. Here press Create record
   <img src="assets/images/beanstalk_post/beanstalk_17.png">
5. Here enable Alias and select the options Alias to Elastic Beanstalk, AWS Zone where your beanstalk is, 
and environment from the select options:
   <img src="assets/images/beanstalk_post/beanstalk_18.png">

Also, as you can see I have chosen @ symbol to match both www and without it to my beanstalk app.

Great! Soon enough you should be able to navigate to your app using your register domain.

You have probably notices that it is still not secure. That is because the Beanstalk Load Balancer 
is still listening at the default 80 port.

## Setting up LoadBalancer for HTTPS
Go back to Beanstalk section in your AWS Console. Select Configuration and then edit Load Balancer.

*If you don't have edit available because you environment doesn't have a load balancer you need to change 
your environment type by pressing "edit" in capacity. There change the type to `Load balanced` one and press `Apply` 
(also confirm when warning message popups)*
<img src="assets/images/beanstalk_post/beanstalk_19.png">

Now that you are editing Load Balancer, add another Listener, with port 443, HTTPS and select your certificate. 
Don't forget to press apply
<img src="assets/images/beanstalk_post/beanstalk_20.png">

We are almost done. Now I like to set up redirects from port 80 to port 443. Go to EC2 section and choose 
Load Balancers.

There go to Listeners Tab, delete the default 80 rule and instead create new one and select 
Redirect To... redirecting it to 443

<img src="assets/images/beanstalk_post/beanstalk_21.png">

That was it! Have fun with your new secure app.
